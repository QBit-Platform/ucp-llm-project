<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🌌 هيباتيا - بروتوكول المستخدم</title> <!-- Updated Title -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --primary-bg: #f4f4f9;
            --secondary-bg: #ffffff;
            --primary-text: #333333;
            --secondary-text: #555555;
            --accent-color: #007bff;
            --eve-message-bg: linear-gradient(135deg, #e6f3ff, #c3e0ff);
            --user-message-bg: linear-gradient(135deg, #d4edda, #b3e0c0);
            --button-bg: #007bff;
            --button-hover-bg: #0056b3;
            --skip-button-bg: #6c757d;
            --skip-button-hover-bg: #5a6268;
            --danger-button-bg: #dc3545;
            --danger-button-hover-bg: #c82333;
            --menu-bg: #ffffff;
            --menu-border: #dddddd;
            --menu-hover-bg: #f0f0f0;
            --modal-bg: #ffffff;
            --modal-border: #dddddd;
            --input-bg: #ffffff;
            --input-border: #dddddd;
            --box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            --section-title-color: #007bff;
        }

        .dark-mode {
            --primary-bg: #2c2c2c;
            --secondary-bg: #383838;
            --primary-text: #f0f0f0;
            --secondary-text: #cccccc;
            --accent-color: #4dabf7;
            --eve-message-bg: linear-gradient(135deg, #3b5c8c, #4a6fa5);
            --user-message-bg: linear-gradient(135deg, #2e4d36, #3d6647);
            --button-bg: #4dabf7;
            --button-hover-bg: #2196f3;
            --skip-button-bg: #757575;
            --skip-button-hover-bg: #616161;
            --danger-button-bg: #f44336;
            --danger-button-hover-bg: #d32f2f;
            --menu-bg: #444444;
            --menu-border: #555555;
            --menu-hover-bg: #505050;
            --modal-bg: #444444;
            --modal-border: #555555;
            --input-bg: #505050;
            --input-border: #666666;
            --section-title-color: #4dabf7;
        }

        body {
            font-family: 'Arial', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--primary-bg);
            color: var(--primary-text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        .app-header {
            text-align: center;
            margin-top: 20px;
        }

        .app-header h2 {
            color: var(--primary-text);
            margin-bottom: 5px;
        }

        .app-header #app-version {
            font-size: 0.9em;
            color: var(--secondary-text);
        }

        .container {
            width: 90%;
            max-width: 700px;
            margin: 20px auto;
            background: var(--secondary-bg);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border-radius: 8px;
            position: relative;
        }

        .menu-button {
            position: fixed; /* Changed from absolute for better positioning */
            top: 15px;
            left: 15px; /* Consistent positioning */
            font-size: 24px;
            cursor: pointer;
            color: var(--primary-text);
            background-color: var(--button-bg);
            color: white;
            padding: 8px 12px;
            border-radius: 50%;
            box-shadow: var(--box-shadow);
            z-index: 1001; /* Ensure it's above other elements */
        }
        .menu-button:hover {
            background-color: var(--button-hover-bg);
        }

        .menu {
            display: none;
            position: fixed; /* Changed from absolute */
            top: 60px;      /* Adjusted for fixed menu button */
            left: 15px;
            background: var(--menu-bg);
            border: 1px solid var(--menu-border);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border-radius: 5px;
            z-index: 1000;
            width: 250px; /* Defined width */
        }

        .menu button {
            display: flex; /* For icon alignment */
            align-items: center;
            width: 100%;
            padding: 12px 15px;
            border: none;
            background: none;
            text-align: right; /* Adjusted for RTL */
            cursor: pointer;
            color: var(--primary-text);
            font-size: 1em;
            border-bottom: 1px solid var(--menu-border);
        }
        .menu button:last-child {
            border-bottom: none;
        }
        .menu button i {
            margin-left: 10px; /* Space between icon and text (for LTR, use margin-right for RTL) */
             margin-right: 0; /* Reset for RTL */
        }
        /* RTL specific for menu icon */
        [dir="rtl"] .menu button i {
            margin-right: 10px;
            margin-left: 0;
        }
        .menu button:hover {
            background: var(--menu-hover-bg);
        }

        .chat-box {
            height: 450px;
            overflow-y: auto;
            border: 1px solid var(--input-border);
            padding: 15px;
            margin-bottom: 15px;
            background: var(--primary-bg); /* Slightly different from container for depth */
            border-radius: 5px;
        }

        .message {
            margin-bottom: 12px;
            padding: 12px 18px;
            border-radius: 18px; /* More rounded */
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            max-width: 75%;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .hypatia-message { /* Renamed from eve-message */
            background: var(--eve-message-bg);
            color: var(--primary-text); /* Ensure contrast */
            text-align: right;
            margin-left: auto; /* Pushes to the right */
        }

        .user-message {
            background: var(--user-message-bg);
            color: var(--primary-text); /* Ensure contrast */
            text-align: left;
            margin-right: auto; /* Pushes to the left */
        }
        /* RTL specific alignments */
        [dir="rtl"] .hypatia-message {
            text-align: right;
            margin-left: auto;
            margin-right: 0;
        }
        [dir="rtl"] .user-message {
            text-align: right; /* User messages also align to right in RTL */
            margin-left: auto; /* Pushes to the right in RTL */
            margin-right: 0;
        }
        [dir="ltr"] .hypatia-message {
            text-align: left;
            margin-right: auto;
            margin-left: 0;
        }
        [dir="ltr"] .user-message {
            text-align: left;
            margin-right: auto;
            margin-left: 0;
        }


        .section-title {
            font-weight: bold;
            color: var(--section-title-color);
            margin: 20px 10px 10px;
            padding-bottom: 5px;
            border-bottom: 1px dashed var(--section-title-color);
            text-align: center;
        }

        #input-container {
            display: flex;
            gap: 10px;
        }

        .input-box, .dynamic-input { /* Combined styles */
            flex-grow: 1;
            padding: 12px;
            font-size: 1em;
            border: 1px solid var(--input-border);
            border-radius: 5px;
            background-color: var(--input-bg);
            color: var(--primary-text);
        }
        .dynamic-input select {
             width: 100%;
        }
        .dynamic-input div { /* For checkbox container */
            padding: 5px 0;
        }
        .dynamic-input div label {
            display: block;
            margin: 8px 0;
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        .dynamic-input div label:hover {
            background-color: rgba(0,0,0,0.05);
        }
        .dynamic-input div input[type="checkbox"] {
            margin-right: 8px; /* LTR */
             margin-left: 0; /* RTL Reset */
        }
        [dir="rtl"] .dynamic-input div input[type="checkbox"] {
            margin-left: 8px;
            margin-right: 0;
        }


        button.action-button { /* Generic class for main action buttons */
            padding: 12px 18px;
            font-size: 1em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            background-color: var(--button-bg);
            color: white;
        }
        button.action-button:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-1px);
        }
        button.action-button:active {
            transform: translateY(0px);
        }

        #skip-button {
            background: var(--skip-button-bg);
        }
        #skip-button:hover {
            background: var(--skip-button-hover-bg);
        }


        #alert-box { /* Renamed from alert */
            display: none;
            position: fixed;
            bottom: 20px; /* Positioned at the bottom */
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-color);
            color: white;
            padding: 12px 25px;
            border-radius: 5px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            z-index: 1002;
            font-size: 0.95em;
        }
        #alert-box.error {
            background-color: var(--danger-button-bg);
        }
         #alert-box.success {
            background-color: #28a745; /* Specific success color */
        }


        #loading-indicator {
            display: none;
            position: fixed; /* Changed to fixed for full viewport centering */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.3); /* Semi-transparent overlay */
            z-index: 1005; /* High z-index */
            justify-content: center;
            align-items: center;
        }
        #loading-indicator i {
            font-size: 48px;
            color: var(--accent-color);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5); /* Overlay */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 15px; /* For smaller screens */
        }
        .modal-content {
            background: var(--modal-bg);
            padding: 25px;
            border: 1px solid var(--modal-border);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative; /* For close button positioning */
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--input-border);
        }
        .modal-header h3 {
            margin: 0;
            color: var(--primary-text);
            font-size: 1.3em;
        }
        .modal-close-button {
            background: none;
            border: none;
            font-size: 1.8em;
            color: var(--secondary-text);
            cursor: pointer;
            padding: 0 5px;
        }
        .modal-close-button:hover {
            color: var(--primary-text);
        }
        .modal-body {
            margin-bottom: 20px;
        }
        .modal-body select, .modal-body textarea, .modal-body input[type="text"] {
            width: calc(100% - 24px); /* Account for padding */
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 5px;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            color: var(--primary-text);
            font-size: 1em;
        }
         .modal-body textarea {
            min-height: 100px;
            resize: vertical;
        }
        .modal-body .checkbox-group label, .modal-body .radio-group label {
            display: block;
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
        }
        .modal-body .checkbox-group label:hover, .modal-body .radio-group label:hover {
            background-color: rgba(0,0,0,0.05);
        }
         .modal-body .checkbox-group input, .modal-body .radio-group input {
            margin-right: 8px; /* LTR */
         }
        [dir="rtl"] .modal-body .checkbox-group input, [dir="rtl"] .modal-body .radio-group input {
            margin-left: 8px;
            margin-right: 0;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end; /* Align buttons to the right */
            gap: 10px;
        }
        .modal-footer button {
            padding: 10px 20px;
            font-size: 0.95em;
        }
        .modal-footer .confirm-button {
            background-color: var(--button-bg);
            color: white;
        }
        .modal-footer .confirm-button:hover {
            background-color: var(--button-hover-bg);
        }
        .modal-footer .cancel-button {
            background-color: var(--skip-button-bg);
            color: white;
        }
        .modal-footer .cancel-button:hover {
            background-color: var(--skip-button-hover-bg);
        }
        .modal-footer .danger-button {
            background-color: var(--danger-button-bg);
            color: white;
        }
        .modal-footer .danger-button:hover {
            background-color: var(--danger-button-hover-bg);
        }

        #report-content .report-section {
            margin-bottom: 20px;
            padding: 15px;
            background: var(--primary-bg); /* Match chat-box background */
            border-radius: 5px;
            border: 1px solid var(--input-border);
        }
        #report-content .report-section h5 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--accent-color);
        }
        #report-content .report-section p {
            margin-bottom: 5px;
            line-height: 1.5;
        }

        #guide-content {
            white-space: pre-wrap; /* Ensure text wraps */
            background: var(--primary-bg);
            padding: 15px;
            border-radius: 5px;
            border: 1px solid var(--input-border);
            line-height: 1.6;
        }

        #skipped-questions-list {
            list-style-type: none;
            padding: 0;
        }
        #skipped-questions-list li {
            padding: 10px;
            border-bottom: 1px solid var(--input-border);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #skipped-questions-list li:last-child {
            border-bottom: none;
        }
        #skipped-questions-list li:hover {
            background-color: var(--menu-hover-bg);
        }
        #skipped-questions-list .retry-link {
            color: var(--accent-color);
            text-decoration: none;
            font-weight: bold;
            margin-left: 10px; /* LTR */
        }
        [dir="rtl"] #skipped-questions-list .retry-link {
            margin-right: 10px;
            margin-left: 0;
        }


        @media (max-width: 600px) {
            .container {
                width: 95%;
                padding: 15px;
            }
            .chat-box {
                height: 350px;
            }
            .menu {
                width: 220px;
            }
            .modal-content {
                padding: 20px;
            }
            .app-header h2 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="app-header">
        <h2>🌌 هيباتيا - بروتوكول المستخدم</h2>
        <div id="app-version">هيباتيا الإصدار 1.0.0</div>
    </div>

    <div class="container">
        <div id="chat-box" class="chat-box"></div>
        <div id="input-container">
            <!-- Input box and buttons will be dynamically created/managed by JS -->
        </div>
    </div>

    <button id="menu-button" class="menu-button" aria-label="Open Menu"><i class="fas fa-bars"></i></button>
    <div id="menu" class="menu">
        <button id="export-button"><i class="fas fa-download"></i> <span data-translate="export">تصدير كـ JSON</span></button>
        <button id="save-button"><i class="fas fa-save"></i> <span data-translate="save">حفظ</span></button>
        <button id="import-button"><i class="fas fa-upload"></i> <span data-translate="import">استيراد</span></button>
        <button id="edit-answers-button"><i class="fas fa-edit"></i> <span data-translate="editAnswers">تحرير الإجابات</span></button>
        <button id="skipped-questions-button"><i class="fas fa-list-ul"></i> <span data-translate="skippedQuestions">الأسئلة المتخطاة</span></button>
        <!-- retrySkippedButton might be removed or repurposed if skipped questions are handled in a modal -->
        <button id="report-button"><i class="fas fa-file-alt"></i> <span data-translate="report">عرض التقرير النهائي</span></button>
        <button id="user-guide-button"><i class="fas fa-book-open"></i> <span data-translate="userGuide">دليل المستخدم</span></button>
        <button id="reset-button" class="danger-button-style"><i class="fas fa-undo-alt"></i> <span data-translate="reset">إعادة تعيين</span></button>
        <button id="language-button"><i class="fas fa-globe"></i> <span data-translate="language">تغيير اللغة</span></button>
        <button id="dark-mode-button"><i class="fas fa-adjust"></i> <span data-translate="darkMode">الوضع الليلي</span></button>
    </div>

    <div id="alert-box"></div> <!-- Renamed from alert -->

    <!-- Generic Modal Structure (can be reused) -->
    <div id="generic-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">عنوان النافذة</h3>
                <button class="modal-close-button" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body" id="modal-body-content">
                <!-- Content will be injected here -->
            </div>
            <div class="modal-footer" id="modal-footer-buttons">
                <!-- Buttons will be injected here -->
                <!-- e.g., <button id="modal-confirm-button" class="confirm-button">Confirm</button> -->
                <!-- <button id="modal-cancel-button" class="cancel-button">Cancel</button> -->
            </div>
        </div>
    </div>


    <div id="loading-indicator" style="display: none; justify-content: center; align-items: center;">
        <i class="fas fa-spinner fa-spin"></i>
    </div>

    <input type="file" id="import-input" accept=".json" style="display: none;">

    <script src="data.js"></script>
    <script src="hypatia.js"></script> <!-- Will be renamed to hypatia.js -->
</body>
</html>
