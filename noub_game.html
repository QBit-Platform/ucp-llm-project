<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Caps Game</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        :root {
            --background-dark: #121212;
            --surface-dark: #1e1e1e;
            --primary-accent: #ff453a;
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --diamond-color: #00bfff;
            --success-color: #34c759;
        }
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--background-dark);
            color: var(--text-primary);
            margin: 0;
            padding: 15px 15px 95px 15px;
            -webkit-font-smoothing: antialiased;
        }
        .hidden { display: none !important; }
        
        /* --- Components --- */
        .header { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 8px 20px; border: none; border-radius: 20px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s ease-in-out; user-select: none; }
        .tab.active { background-color: var(--primary-accent); color: var(--text-primary); }
        .tab.inactive { background-color: var(--surface-dark); color: var(--text-secondary); }

        .balance-bar { display: flex; align-items: center; background-color: var(--surface-dark); border-radius: 12px; padding: 10px 15px; margin-bottom: 25px; }
        .balance-bar .icon { font-size: 24px; color: var(--diamond-color); }
        .balance-bar .amount { font-size: 20px; font-weight: bold; margin: 0 10px; flex-grow: 1; }
        .balance-bar #connectButton { background-color: #48484a; color: var(--text-primary); border-radius: 50%; width: 32px; height: 32px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .screen { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .card-item { background-color: var(--surface-dark); border-radius: 16px; overflow: hidden; padding: 10px; position: relative; }
        .card-item .card-image { width: 100%; aspect-ratio: 1 / 1; border-radius: 12px; object-fit: cover; margin-bottom: 10px; background-color: #333; }
        .card-item .card-info h3 { margin: 0 0 5px 0; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-item .card-info p { margin: 0; font-size: 14px; color: var(--text-secondary); display: flex; align-items: center; }
        .card-item .card-info .icon { color: var(--diamond-color); margin-left: 5px; }
        .card-item .card-badge { position: absolute; top: 18px; left: 18px; background-color: rgba(0, 0, 0, 0.6); color: white; padding: 3px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; }

        .quests-list { display: flex; flex-direction: column; gap: 15px; }
        .quest-item { display: flex; align-items: center; background-color: var(--surface-dark); padding: 15px; border-radius: 12px; }
        .quest-item .icon { font-size: 32px; margin-left: 15px; }
        .quest-item .details { flex-grow: 1; }
        .quest-item .details h4 { margin: 0 0 5px 0; }
        .quest-item .details p { margin: 0; font-size: 14px; color: var(--text-secondary); }
        .quest-item .claim-btn { padding: 8px 20px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; user-select: none; }
        .quest-item .claim-btn.ready { background-color: var(--success-color); color: white; }
        .quest-item .claim-btn.claimed { background-color: transparent; border: 1px solid var(--text-secondary); color: var(--text-secondary); }

        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 100; animation: fadeIn 0.3s; }
        .modal-content { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--surface-dark); border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 20px; z-index: 101; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-content h2 { margin-top: 0; }
        .shop-item { display: flex; align-items: center; margin-top: 20px; background-color: #3a3a3c; padding: 15px; border-radius: 12px; }
        .shop-item .icon { font-size: 40px; margin-left: 20px; }
        .shop-item .details { flex-grow: 1; }
        .shop-item .buy-btn { padding: 10px 25px; border-radius: 10px; border: none; background-color: var(--primary-accent); color: white; font-weight: bold; font-size: 16px; cursor: pointer; user-select: none; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around; background-color: rgba(28, 28, 30, 0.85); backdrop-filter: blur(10px); padding: 10px 0 15px 0; border-top: 1px solid #3a3a3c; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-secondary); text-decoration: none; font-size: 12px; cursor: pointer; user-select: none; }
        .nav-item.active { color: var(--primary-accent); }
        .nav-item .icon { font-size: 24px; margin-bottom: 4px; }
    </style>
</head>
<body>
    <header>
        <div class="header">
            <button class="tab active" data-target="home-screen">Caps</button>
            <button class="tab inactive" data-target="activity-screen">Activity</button>
        </div>
        <div class="balance-bar">
            <div class="icon">💎</div>
            <span class="amount" id="score-display">0</span>
            <div id="connectButton"></div>
        </div>
    </header>
    <main id="content-container">
        <div id="home-screen" class="screen">
            <div class="card-grid" id="collection-container"></div>
        </div>
        <div id="activity-screen" class="screen hidden">
            <h3 style="color: var(--text-secondary); text-align:center;">لا يوجد نشاط لعرضه حاليًا.</h3>
        </div>
        <div id="quests-screen" class="screen hidden">
            <div class="quests-list" id="quests-container"></div>
        </div>
    </main>
    <div id="shop-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 style="display: flex; justify-content: space-between; align-items: center;">المتجر<span id="close-shop-btn" style="cursor:pointer; font-size: 24px;">&times;</span></h2>
            <div class="shop-item">
                <div class="icon">🎁</div>
                <div class="details"><h4>حزمة كروت</h4><p style="color: var(--text-secondary);">احصل على كرت عشوائي!</p></div>
                <button class="buy-btn" id="buy-pack-btn">10 💎</button>
            </div>
            <div class="shop-item">
                <div class="icon">✨</div>
                <div class="details"><h4>صندوق حظ</h4><p style="color: var(--text-secondary);">كرت عشوائي + نقاط إضافية!</p></div>
                <button class="buy-btn" id="buy-lootbox-btn">25 💎</button>
            </div>
        </div>
    </div>
    <nav class="bottom-nav">
        <a class="nav-item active" data-target="home-screen"><div class="icon">🕹️</div><span>Home</span></a>
        <a class="nav-item" data-target="quests-screen"><div class="icon">💎</div><span>Quests</span></a>
        <a class="nav-item" id="shop-nav-btn"><div class="icon">🛍️</div><span>Shop</span></a>
        <a class="nav-item" data-target="market-screen" onclick="alert('السوق غير متاح بعد!');"><div class="icon">📈</div><span>Market</span></a>
    </nav>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. CONFIGURATION & GAME STATE ---
            const allCards = [
                { id: 1, name: "المحارب الفولاذي", image: "images/card1.png", rarity: "Common" },
                { id: 2, name: "ساحرة الغابة", image: "images/card2.png", rarity: "Common" },
                { id: 3, name: "غولم الصخر", image: "images/card3.png", rarity: "Common" },
                { id: 4, name: "جنية الأثير", image: "images/card4.png", rarity: "Rare" },
                { id: 5, name: "تنين الحمم", image: "images/card5.png", rarity: "Rare" },
                { id: 6, name: "روح الثلج", image: "images/card6.png", rarity: "Rare" },
                { id: 7, name: "كائن الظل", image: "images/card7.png", rarity: "Epic" },
                { id: 8, name: "طائر الرعد", image: "images/card8.png", rarity: "Epic" },
                { id: 9, name: "العنقاء السماوية", image: "images/card9.png", rarity: "Legendary" },
                { id: 10, name: "سيد الفراغ", image: "images/card10.png", rarity: "Legendary" }
            ];
            let quests = [
                { id: 1, title: "المبتدئ الطموح", description: "احصل على أول كرت لك.", reward: 20, isCompleted: () => playerCollection.length >= 1, isClaimed: false },
                { id: 2, title: "جامع واعد", description: "اجمع 5 كروت مختلفة.", reward: 50, isCompleted: () => new Set(playerCollection.map(c => c.id)).size >= 5, isClaimed: false },
                { id: 3, title: "صاحب الثروة", description: "اجمع 100 نقطة.", reward: 30, isCompleted: () => score >= 100, isClaimed: false }
            ];
            let score = 0;
            let playerCollection = [];
            const packCost = 10;
            const lootBoxCost = 25;

            // --- 2. DOM ELEMENT REFERENCES ---
            const scoreDisplay = document.getElementById('score-display');
            const collectionContainer = document.getElementById('collection-container');
            const questsContainer = document.getElementById('quests-container');
            const shopModal = document.getElementById('shop-modal');
            const navItems = document.querySelectorAll('.nav-item');
            const tabs = document.querySelectorAll('.tab');
            const screens = document.querySelectorAll('.screen');

            // --- 3. PERSISTENCE (SAVE & LOAD) ---
            function saveGame() {
                const gameState = { score, collection: playerCollection, quests: quests.map(q => ({id: q.id, isClaimed: q.isClaimed})) };
                localStorage.setItem('capsGameSave', JSON.stringify(gameState));
            }

            function loadGame() {
                const savedData = localStorage.getItem('capsGameSave');
                if (savedData) {
                    const gameState = JSON.parse(savedData);
                    score = gameState.score || 0;
                    playerCollection = gameState.collection || [];
                    if (gameState.quests) {
                        gameState.quests.forEach(savedQuest => {
                            const quest = quests.find(q => q.id === savedQuest.id);
                            if (quest) quest.isClaimed = savedQuest.isClaimed;
                        });
                    }
                }
            }
            
            // --- 4. CORE GAME LOGIC ---
            function buyCardPack() {
                if (score >= packCost) {
                    score -= packCost;
                    const randomCard = allCards[Math.floor(Math.random() * allCards.length)];
                    playerCollection.push(randomCard);
                    alert(`تهانينا! لقد حصلت على كرت: ${randomCard.name}`);
                    updateUI();
                } else { alert("رصيدك غير كافٍ!"); }
            }

            function buyLootBox() {
                if (score >= lootBoxCost) {
                    score -= lootBoxCost;
                    const randomCard = allCards[Math.floor(Math.random() * allCards.length)];
                    playerCollection.push(randomCard);
                    const pointsWon = Math.floor(Math.random() * (50 - 10 + 1)) + 10;
                    score += pointsWon;
                    alert(`تهانينا! حصلت على: ${randomCard.name} + ${pointsWon} نقطة إضافية!`);
                    updateUI();
                } else { alert("رصيدك غير كافٍ!"); }
            }
            
            window.claimQuest = function(questId) {
                const quest = quests.find(q => q.id === questId);
                if (quest && quest.isCompleted() && !quest.isClaimed) {
                    score += quest.reward;
                    quest.isClaimed = true;
                    alert(`لقد حصلت على ${quest.reward} نقطة!`);
                    updateUI();
                }
            }

            // --- 5. UI RENDERING ---
            function renderCollection() {
                collectionContainer.innerHTML = '';
                if (playerCollection.length === 0) {
                    collectionContainer.innerHTML = "<p style='grid-column: 1 / -1; color: var(--text-secondary); text-align: center;'>مجموعتك فارغة. احصل على كروتك الأولى من المتجر!</p>";
                } else {
                    playerCollection.forEach(card => {
                        const cardElement = document.createElement('div');
                        cardElement.classList.add('card-item');
                        const price = card.rarity === 'Legendary' ? 5.0 : (card.rarity === 'Epic' ? 1.0 : (card.rarity === 'Rare' ? 0.5 : 0.1));
                        cardElement.innerHTML = `
                            <div class="card-badge">#${card.id}</div> 
                            <img src="${card.image}" alt="${card.name}" class="card-image">
                            <div class="card-info">
                                <h3>${card.name}</h3>
                                <p>${card.rarity} ${price} <span class="icon">💎</span></p>
                            </div>`;
                        collectionContainer.appendChild(cardElement);
                    });
                }
            }
            
            function renderQuests() {
                questsContainer.innerHTML = '';
                quests.forEach(quest => {
                    const questElement = document.createElement('div');
                    questElement.classList.add('quest-item');
                    let buttonHtml;
                    if (quest.isClaimed) {
                        buttonHtml = `<button class="claim-btn claimed" disabled>تم</button>`;
                    } else if (quest.isCompleted()) {
                        buttonHtml = `<button class="claim-btn ready" onclick="claimQuest(${quest.id})">احصل</button>`;
                    } else {
                        buttonHtml = `<button class="claim-btn claimed" disabled>${quest.reward} 💎</button>`;
                    }
                    questElement.innerHTML = `
                        <div class="icon">⭐</div>
                        <div class="details"><h4>${quest.title}</h4><p>${quest.description}</p></div>
                        ${buttonHtml}`;
                    questsContainer.appendChild(questElement);
                });
            }

            function updateUI() {
                scoreDisplay.textContent = score;
                renderCollection();
                renderQuests();
                saveGame();
            }

            // --- 6. NAVIGATION & EVENT HANDLING ---
            function navigateTo(targetId) {
                screens.forEach(screen => screen.classList.add('hidden'));
                const targetScreen = document.getElementById(targetId);
                if (targetScreen) targetScreen.classList.remove('hidden');

                navItems.forEach(item => item.classList.toggle('active', item.dataset.target === targetId));
                
                const isHomeOrActivity = targetId === 'home-screen' || targetId === 'activity-screen';
                if (isHomeOrActivity) {
                    tabs.forEach(tab => tab.classList.toggle('active', tab.dataset.target === targetId));
                    tabs.forEach(tab => tab.classList.toggle('inactive', tab.dataset.target !== targetId));
                }
            }

            navItems.forEach(item => {
                if (item.dataset.target) {
                    item.addEventListener('click', () => navigateTo(item.dataset.target));
                }
            });

            tabs.forEach(tab => {
                tab.addEventListener('click', () => navigateTo(tab.dataset.target));
            });
            
            document.getElementById('shop-nav-btn').addEventListener('click', () => shopModal.classList.remove('hidden'));
            document.getElementById('close-shop-btn').addEventListener('click', () => shopModal.classList.add('hidden'));
            document.getElementById('buy-pack-btn').addEventListener('click', buyCardPack);
            document.getElementById('buy-lootbox-btn').addEventListener('click', buyLootBox);

            // --- 7. INITIALIZATION ---
            loadGame();
            updateUI();
            navigateTo('home-screen');

            // --- 8. TON CONNECT INTEGRATION ---
            const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                manifestUrl: 'https://github.com/QBit-Platform/ucp-llm-project/blob/main/tonconnect-manifest.json', // <-- !!! مهم: استبدل هذا الرابط
                buttonRootId: 'connectButton'
            });
        });
    </script>
</body>
</html>
